from pathlib import Path

from aiogram import Router, F
from aiogram.filters import StateFilter
from aiogram.fsm.context import FSMContext
from aiogram.types import CallbackQuery, Message, InlineKeyboardButton, FSInputFile
from aiogram.utils.keyboard import InlineKeyboardBuilder

from bot.fsm.fsm import MiniDialogSG

router = Router(name="mini_dialog_router")


@router.callback_query(StateFilter(MiniDialogSG.greeting), F.data == "greeting_btn")
async def greeting_command(callback: CallbackQuery, state: FSMContext):
    await callback.message.delete_reply_markup()
    await callback.message.edit_text(
        text="–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, –º–æ–π –¥–æ—Ä–æ–≥–æ–π –¥—Ä—É–≥!\n\n"
             "–Ø –ø—Ä–∏–≥–ª–∞—à–∞—é –í–∞—Å –≤ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ. –¢–∞–∫ –¥–æ–ª–≥–æ —è –¥—É–º–∞–ª–∞ –Ω–∞–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —ç—Ç–æ–≥–æ —Å–≤–µ—Ç–ª–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞.\n\n"
             "–û–¥–Ω–∞–∂–¥—ã, —Å–æ–∑–¥–∞–≤ –∫–æ–ª–æ–¥—É –ö—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –ö—Ä–∞–π–æ–Ω–∞, —è –ø–æ–Ω—è–ª–∞, —á—Ç–æ –µ—Å—Ç—å –º–æ–º–µ–Ω—Ç—ã, –∫–æ–≥–¥–∞ –º–Ω–µ –Ω—É–∂–Ω–∞ –∏—Ö –ø–æ–º–æ—â—å.\n\n"
             "–ò —Ç–æ–≥–¥–∞ —è —Ä–µ—à–∏–ª–∞—Å—å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —ç—Ç–æ–≥–æ —Å–≤–µ—Ç–ª–æ–≥–æ –º–µ—Å—Ç–∞.\n"
             "–Ø –Ω–∞–ø–æ–ª–Ω–∏–ª–∞ –µ–≥–æ —Å–≤–µ—Ç–æ–º –≤—Å–µ–æ–±—ä–µ–º–ª—é—â–∏–π –ª—é–±–≤–∏ –∏ —Å —Ç—Ä–µ–ø–µ—Ç–æ–º –æ—Ç–Ω–æ—à—É—Å—å –∫ –∫–∞–∂–¥–æ–º—É, –∫—Ç–æ —Å—é–¥–∞ –∑–∞—à—ë–ª.\n\n"
             "<b>‚û¢ –í–ø–µ—Ä–µ–¥ –≤ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ‚ú®</b>"
    )

    await callback.message.answer(
        text="–î–∞–≤–∞–π—Ç–µ –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è!üòä\n–ö–∞–∫ –í–∞—Å –∑–æ–≤—É—Ç?"
    )
    await state.set_state(MiniDialogSG.name)
    await callback.answer()


@router.message(StateFilter(MiniDialogSG.name), F.text)
async def name_command(message: Message, state: FSMContext):
    user_name = message.text.strip()
    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="–ò—Å—Ç–æ—Ä–∏—è –ö—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –ö—Ä–∞–π–æ–Ω–∞", callback_data="what_is_crystal_history_btn"))

    await state.update_data(name=user_name)
    await message.answer(
        text=f"–û—á–µ–Ω—å –ø—Ä–∏—è—Ç–Ω–æ, {user_name}ü•∞\n"
             "–ú–µ–Ω—è –∑–æ–≤—É—Ç –¢–∞—Ç—å—è–Ω–∞\n"
             "–°–µ–π—á–∞—Å —è –ø–æ–∑–Ω–∞–∫–æ–º–ª—é –í–∞—Å —Å –ö—Ä–∏—Å—Ç–∞–ª–ª–∞–º–∏ –ö—Ä–∞–π–æ–Ω–∞üíé\n\n"
             '–í–æ –≤—Ä–µ–º—è –≤—Å–µ–≥–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è, –µ—Å–ª–∏ —É –í–∞—Å –±—É–¥—É—Ç –≤–æ–ø—Ä–æ—Å—ã, '
             '–í—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –æ–±—Ä–∞—Ç–∏—Ç—Å—è –∫–æ –º–Ω–µ, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É <b>"–ü–æ–º–æ—â—å ‚ù§Ô∏è"</b> –∏ —è —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º –í–∞–º –ø–æ–º–æ–≥—É',
        reply_markup=builder.as_markup(),
    )
    await state.set_state(MiniDialogSG.story_crystal)


@router.callback_query(StateFilter(MiniDialogSG.story_crystal), F.data == "what_is_crystal_history_btn")
async def what_is_crystal_history_command(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()

    await callback.message.delete_reply_markup()
    await callback.message.edit_text(
        text=f"–û—á–µ–Ω—å –ø—Ä–∏—è—Ç–Ω–æ, {data['name']}ü•∞\n"
             "–ú–µ–Ω—è –∑–æ–≤—É—Ç –¢–∞—Ç—å—è–Ω–∞\n"
             "–°–µ–π—á–∞—Å —è –ø–æ–∑–Ω–∞–∫–æ–º–ª—é –í–∞—Å —Å –ö—Ä–∏—Å—Ç–∞–ª–ª–∞–º–∏ –ö—Ä–∞–π–æ–Ω–∞üíé\n\n"
             '–í–æ –≤—Ä–µ–º—è –≤—Å–µ–≥–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è, –µ—Å–ª–∏ —É –í–∞—Å –±—É–¥—É—Ç –≤–æ–ø—Ä–æ—Å—ã, '
             '–í—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –æ–±—Ä–∞—Ç–∏—Ç—Å—è –∫–æ –º–Ω–µ, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É <b>"–ü–æ–º–æ—â—å ‚ù§Ô∏è"</b> –∏ —è —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º –í–∞–º –ø–æ–º–æ–≥—É\n\n'
             '<b>‚û¢ –ò—Å—Ç–æ—Ä–∏—è –ö—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –ö—Ä–∞–π–æ–Ω–∞</b>'
    )

    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="–ê —á—Ç–æ —Ç–∞–∫–æ–µ –ö—Ä–∏—Å—Ç–∞–ª–ª—ã?", callback_data="what_is_crystal_btn"))

    await callback.message.answer_video(
        caption="–ò—Å—Ç–æ—Ä–∏—è –ö—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –Ω–∞—á–∞–ª–∞—Å—å –µ—â–µ –≤–æ –≤—Ä–µ–º–µ–Ω–∞ –≤–µ–ª–∏–∫–∏—Ö –ê—Ç–ª–∞–Ω—Ç–æ–≤ –≤ –ê—Ç–ª–∞–Ω—Ç–∏–¥–µ.\n\n"
                "–û–Ω–∏ —è–≤–ª—è—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è–º–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –æ–±–ª–∞–¥–∞—é—Ç –≤–µ–ª–∏–∫–æ–π —Å–∏–ª–æ–π, "
                "–Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–µ–π –∏ –¥–∞–∂–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é –∫ –∏–∑–ª–µ—á–∏–≤–∞–Ω–∏—é. "
                "–ë–ª–∞–≥–æ–¥–∞—Ä—è —Ç–æ–º—É, —á—Ç–æ –ö—Ä–∏—Å—Ç–∞–ª–ª—ã —Å–æ–∑–¥–∞–Ω—ã –∏–∑ –≤—ã—Å–æ—á–∞–π—à–µ–≥–æ —á–∏—Å—Ç–æ–≥–æ —Å–≤–µ—Ç–∞, "
                "–æ–Ω–∏ —è–≤–ª—è—é—Ç—Å—è –æ—Ç–ª–∏—á–Ω—ã–º–∏ –∏ –æ–¥–Ω–∏–º–∏ –∏–∑ —Å–∞–º—ã—Ö –¥–µ–π—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤ "
                "–∫–∞—Ä–º–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ä–æ–¥–æ–≤–æ–π —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏.\n\n"
                "–ö–∞–∂–¥—ã–π –ö—Ä–∏—Å—Ç–∞–ª–ª –ø–æ–¥—á–∏–Ω—è–µ—Ç—Å—è –±–æ–∂–µ—Å—Ç–≤–∞–º, –∏–º–µ–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è "
                "–∏ –¥–∞–∂–µ –æ–±–ª–∞–¥–∞–µ—Ç —Å–≤–æ–∏–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ–º. "
                "–ù–∞ –¥–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –≤—Ä–µ–º–µ–Ω–∏ –ö—Ä–∏—Å—Ç–∞–ª–ª—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å –∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –æ–¥–Ω–æ–º –∏–∑ –ø–æ–º–µ—â–µ–Ω–∏–π "
                "–ø–∏—Ä–∞–º–∏–¥—ã –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –ì–∏–∑–∞, –∫–æ—Ç–æ—Ä–æ–µ –µ—â–µ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–æ",
        video=FSInputFile(path=Path("bot/videos/history_video.mp4")),
        reply_markup=builder.as_markup(),
    )
    await state.set_state(MiniDialogSG.what_is_crystal)
    await callback.answer()


@router.callback_query(StateFilter(MiniDialogSG.what_is_crystal), F.data == "what_is_crystal_btn")
async def what_is_crystal_command_again(callback: CallbackQuery, state: FSMContext):
    await callback.message.delete_reply_markup()
    await callback.message.edit_caption(
        caption="–ò—Å—Ç–æ—Ä–∏—è –ö—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –Ω–∞—á–∞–ª–∞—Å—å –µ—â–µ –≤–æ –≤—Ä–µ–º–µ–Ω–∞ –≤–µ–ª–∏–∫–∏—Ö –ê—Ç–ª–∞–Ω—Ç–æ–≤ –≤ –ê—Ç–ª–∞–Ω—Ç–∏–¥–µ.\n\n"
                "–û–Ω–∏ —è–≤–ª—è—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è–º–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –æ–±–ª–∞–¥–∞—é—Ç –≤–µ–ª–∏–∫–æ–π —Å–∏–ª–æ–π, "
                "–Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–µ–π –∏ –¥–∞–∂–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é –∫ –∏–∑–ª–µ—á–∏–≤–∞–Ω–∏—é. "
                "–ë–ª–∞–≥–æ–¥–∞—Ä—è —Ç–æ–º—É, —á—Ç–æ –ö—Ä–∏—Å—Ç–∞–ª–ª—ã —Å–æ–∑–¥–∞–Ω—ã –∏–∑ –≤—ã—Å–æ—á–∞–π—à–µ–≥–æ —á–∏—Å—Ç–æ–≥–æ —Å–≤–µ—Ç–∞, "
                "–æ–Ω–∏ —è–≤–ª—è—é—Ç—Å—è –æ—Ç–ª–∏—á–Ω—ã–º–∏ –∏ –æ–¥–Ω–∏–º–∏ –∏–∑ —Å–∞–º—ã—Ö –¥–µ–π—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤ "
                "–∫–∞—Ä–º–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ä–æ–¥–æ–≤–æ–π —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∏.\n\n"
                "–ö–∞–∂–¥—ã–π –ö—Ä–∏—Å—Ç–∞–ª–ª –ø–æ–¥—á–∏–Ω—è–µ—Ç—Å—è –±–æ–∂–µ—Å—Ç–≤–∞–º, –∏–º–µ–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è "
                "–∏ –¥–∞–∂–µ –æ–±–ª–∞–¥–∞–µ—Ç —Å–≤–æ–∏–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ–º. "
                "–ù–∞ –¥–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –≤—Ä–µ–º–µ–Ω–∏ –ö—Ä–∏—Å—Ç–∞–ª–ª—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å –∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –æ–¥–Ω–æ–º –∏–∑ –ø–æ–º–µ—â–µ–Ω–∏–π "
                "–ø–∏—Ä–∞–º–∏–¥—ã –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –ì–∏–∑–∞, –∫–æ—Ç–æ—Ä–æ–µ –µ—â–µ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–æ\n\n"
                "<b>‚û¢ –ê —á—Ç–æ —Ç–∞–∫–æ–µ –ö—Ä–∏—Å—Ç–∞–ª–ª—ã?</b>",
    )

    builder = InlineKeyboardBuilder()
    builder.row(InlineKeyboardButton(text="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="go_to_menu"))

    await callback.message.answer(
        text="–ö—Ä–∏—Å—Ç–∞–ª–ª—ã - —ç—Ç–æ –º–∞—Ç—Ä–∏—Ü—ã –í—Å–µ–ª–µ–Ω–Ω–æ–π, —Ö—Ä–∞–Ω—è—â–∏–µ –≤—ã—Å–æ–∫–∏–µ –≤–∏–±—Ä–∞—Ü–∏–∏. "  
             "–í—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ –¥–ª—è —Å–µ–±—è –Ω–µ–æ–±—ã—á–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É –Ω–æ–≤—ã—Ö –∑–Ω–∞–Ω–∏–π. –ö—Ä–∏—Å—Ç–∞–ª–ª—ã –≤–∞–º –ø–æ–∫–∞–∂—É—Ç –∏—Å—Ç–æ—Ä–∏—é " 
             "–≤ –∫–∞—Ä—Ç–∏–Ω–∫–∞—Ö, –∏ –¥–∞–¥—É—Ç —Ç–∞–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –í—ã –Ω–∏–≥–¥–µ –Ω–µ –ø–æ–ª—É—á–∏—Ç–µ. –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ " 
             "–ö—Ä–∏—Å—Ç–∞–ª–ª–∏—á–µ—Å–∫–æ–π —ç–Ω–µ—Ä–≥–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —è–∑—ã–∫–æ–º –°–≤–µ—Ç–∞, –ø–∞–∫–µ—Ç–∞–º–∏ —Å–≤–µ—Ç–æ–≤—ã—Ö –∏–º–ø—É–ª—å—Å–æ–≤. "
             "–ö—Ä–∏—Å—Ç–∞–ª–ª—ã –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç —É—Å–∏–ª–∏—è —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ –°–≤–µ—Ç–∞, –∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –º–µ–Ω—è—é—Ç –∂–∏–∑–Ω—å " 
             "—á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–∞, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—è –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ –º—ã—Å–ª–∏ –∏ —ç–º–æ—Ü–∏–∏. –ü—Ä–∏ "
             "—Å–æ–ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–∏–∏ —Å —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø–æ–ª—è–º–∏ —Å–ø–æ—Å–æ–±—Å—Ç–≤—É—é—Ç —Å–∫–æ—Ä–µ–π—à–µ–π –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ " 
             "–≤–∞—à–∏—Ö –Ω–∞–º–µ—Ä–µ–Ω–∏–π –∏ –º—ã—Å–ª–µ—Ñ–æ—Ä–º\n\n"
             "<b>–Ø –ø—Ä–µ–¥–ª–∞–≥–∞—é –í–∞–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ö—Ä–∏—Å—Ç–∞–ª–ª–∞–º–∏ –ö—Ä–∞–π–æ–Ω–∞</b>",
        reply_markup=builder.as_markup(),
    )
    await state.clear()
    await callback.answer()
